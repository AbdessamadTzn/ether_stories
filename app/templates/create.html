{% extends "base.html" %} {% block content %}
<div class="container mt-4">
  <div class="text-center mb-4">
    <h1 class="display-5 text-magical-gold">
      ‚ú® Cr√©er une Histoire Magique ‚ú®
    </h1>
    <p class="hero-subtitle" style="font-size: 1.1rem">
      Laissez la magie op√©rer...
    </p>
  </div>

  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
      <div class="card shadow-lg">
        <div class="card-body p-4">
          <!-- Input Mode Toggle -->
          <div class="mb-4 text-center">
            <div class="btn-group" role="group" aria-label="Mode de saisie">
              <button
                type="button"
                class="btn btn-primary active"
                id="textModeBtn"
                onclick="switchToTextMode()"
              >
                <i class="bi bi-pencil"></i> √âcrire
              </button>
              <button
                type="button"
                class="btn btn-outline-primary"
                id="voiceModeBtn"
                onclick="switchToVoiceMode()"
              >
                <i class="bi bi-mic"></i> Parler
              </button>
            </div>
          </div>

          <form id="storyForm">
            <div class="mb-4">
              <label for="age" class="form-label"
                ><i class="bi bi-person-heart"></i> √Çge de l'enfant</label
              >
              <input
                type="number"
                class="form-control"
                id="age"
                value="6"
                min="3"
                max="12"
              />
            </div>

            <!-- Text Input Mode -->
            <div id="textInputSection">
              <div class="mb-4">
                <label for="topic" class="form-label"
                  ><i class="bi bi-lightbulb"></i> Sujet / Mots-cl√©s</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="topic"
                  placeholder="Ex: Dinosaures, Espace, Licorne..."
                />
              </div>
            </div>

            <!-- Voice Input Mode -->
            <div id="voiceInputSection" class="d-none">
              <div class="mb-4">
                <label class="form-label"
                  ><i class="bi bi-mic-fill"></i> D√©cris l'histoire que tu
                  veux</label
                >
                <div
                  class="text-center p-4 rounded-4"
                  style="
                    background: rgba(255, 215, 0, 0.1);
                    border: 2px dashed var(--magic-gold);
                  "
                >
                  <div id="recordingStatus" class="mb-3">
                    <span class="text-muted"
                      >Clique sur le micro pour commencer</span
                    >
                  </div>

                  <button
                    type="button"
                    id="recordBtn"
                    class="btn btn-lg rounded-circle p-4"
                    style="
                      background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
                      border: none;
                      color: white;
                    "
                    onclick="toggleRecording()"
                  >
                    <i class="bi bi-mic-fill" style="font-size: 2rem"></i>
                  </button>

                  <div id="recordingIndicator" class="d-none mt-3">
                    <div
                      class="spinner-grow text-danger spinner-grow-sm"
                      role="status"
                    ></div>
                    <span class="text-magical-pink ms-2"
                      >Enregistrement en cours...</span
                    >
                  </div>

                  <div id="audioPreview" class="d-none mt-3">
                    <audio id="audioPlayback" controls class="w-100"></audio>
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-secondary mt-2"
                      onclick="resetRecording()"
                    >
                      <i class="bi bi-arrow-clockwise"></i> R√©enregistrer
                    </button>
                  </div>
                </div>
                <small class="text-muted mt-2 d-block">
                  Ex: "Je veux une histoire avec un petit dragon qui apprend √†
                  voler"
                </small>
              </div>
            </div>

            <div class="mb-4">
              <label for="moral" class="form-label"
                ><i class="bi bi-heart"></i> Morale (Optionnel)</label
              >
              <input
                type="text"
                class="form-control"
                id="moral"
                value="Amiti√© et Courage"
              />
            </div>

            <div class="mb-4">
              <label for="duration" class="form-label"
                ><i class="bi bi-clock"></i> Dur√©e (minutes)</label
              >
              <div class="d-flex align-items-center gap-3">
                <input
                  type="range"
                  class="form-range flex-grow-1"
                  id="duration"
                  min="2"
                  max="10"
                  value="5"
                  oninput="this.nextElementSibling.textContent = this.value"
                />
                <span class="badge bg-primary fs-6" style="min-width: 80px"
                  >5 min</span
                >
              </div>
            </div>

            <div class="d-grid gap-2 mt-4">
              <button
                type="submit"
                class="btn btn-magical-primary btn-lg"
                id="submitBtn"
              >
                <i class="bi bi-stars"></i> G√©n√©rer l'Histoire
              </button>
            </div>
          </form>

          <div id="loading" class="text-center mt-4 d-none">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-magical-gold">
              <i class="bi bi-magic"></i> Nos agents magiques √©crivent votre
              histoire...
              <span id="progress" class="d-block mt-2"></span>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // State variables
  let inputMode = 'text'; // 'text' or 'voice'
  let mediaRecorder = null;
  let audioChunks = [];
  let audioBlob = null;
  let audioPath = null;
  let isRecording = false;

  // Mode switching functions
  function switchToTextMode() {
    inputMode = 'text';
    document.getElementById('textModeBtn').classList.add('active');
    document
      .getElementById('textModeBtn')
      .classList.remove('btn-outline-primary');
    document.getElementById('textModeBtn').classList.add('btn-primary');
    document.getElementById('voiceModeBtn').classList.remove('active');
    document
      .getElementById('voiceModeBtn')
      .classList.add('btn-outline-primary');
    document.getElementById('voiceModeBtn').classList.remove('btn-primary');
    document.getElementById('textInputSection').classList.remove('d-none');
    document.getElementById('voiceInputSection').classList.add('d-none');
    resetRecording();
  }

  function switchToVoiceMode() {
    inputMode = 'voice';
    document.getElementById('voiceModeBtn').classList.add('active');
    document
      .getElementById('voiceModeBtn')
      .classList.remove('btn-outline-primary');
    document.getElementById('voiceModeBtn').classList.add('btn-primary');
    document.getElementById('textModeBtn').classList.remove('active');
    document.getElementById('textModeBtn').classList.add('btn-outline-primary');
    document.getElementById('textModeBtn').classList.remove('btn-primary');
    document.getElementById('voiceInputSection').classList.remove('d-none');
    document.getElementById('textInputSection').classList.add('d-none');
  }

  // Recording functions
  async function toggleRecording() {
    if (!isRecording) {
      await startRecording();
    } else {
      stopRecording();
    }
  }

  async function startRecording() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
      audioChunks = [];

      mediaRecorder.ondataavailable = (event) => {
        audioChunks.push(event.data);
      };

      mediaRecorder.onstop = async () => {
        audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        const audioUrl = URL.createObjectURL(audioBlob);
        document.getElementById('audioPlayback').src = audioUrl;
        document.getElementById('audioPreview').classList.remove('d-none');
        document.getElementById('recordingIndicator').classList.add('d-none');
        document.getElementById('recordingStatus').innerHTML =
          '<span class="text-success">‚úÖ Enregistrement termin√©!</span>';

        // Upload audio file
        await uploadAudio();
      };

      mediaRecorder.start();
      isRecording = true;
      document.getElementById('recordBtn').classList.add('btn-danger');
      document
        .getElementById('recordBtn')
        .classList.remove('btn-outline-danger');
      document.getElementById('recordingIndicator').classList.remove('d-none');
      document.getElementById('recordingStatus').innerHTML =
        '<span class="text-danger">üî¥ Parle maintenant...</span>';
      document.getElementById('audioPreview').classList.add('d-none');
    } catch (error) {
      console.error('Error accessing microphone:', error);
      alert("Impossible d'acc√©der au microphone. V√©rifiez les permissions.");
    }
  }

  function stopRecording() {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
      mediaRecorder.stop();
      mediaRecorder.stream.getTracks().forEach((track) => track.stop());
      isRecording = false;
      document.getElementById('recordBtn').classList.remove('btn-danger');
      document.getElementById('recordBtn').classList.add('btn-outline-danger');
    }
  }

  function resetRecording() {
    audioBlob = null;
    audioPath = null;
    audioChunks = [];
    document.getElementById('audioPreview').classList.add('d-none');
    document.getElementById('recordingIndicator').classList.add('d-none');
    document.getElementById('recordingStatus').innerHTML =
      '<span class="text-muted">Clique sur le micro pour commencer</span>';
    if (isRecording) {
      stopRecording();
    }
  }

  async function uploadAudio() {
    if (!audioBlob) return;

    const formData = new FormData();
    formData.append('audio', audioBlob, 'voice_recording.webm');

    try {
      document.getElementById('recordingStatus').innerHTML =
        '<span class="text-info">üì§ Upload en cours...</span>';

      const response = await fetch('/api/audio/upload', {
        method: 'POST',
        body: formData,
        credentials: 'include',
      });

      if (!response.ok) {
        throw new Error('Upload failed');
      }

      const data = await response.json();
      audioPath = data.audio_path;
      document.getElementById('recordingStatus').innerHTML =
        '<span class="text-success">‚úÖ Pr√™t √† g√©n√©rer l\'histoire!</span>';
    } catch (error) {
      console.error('Upload error:', error);
      document.getElementById('recordingStatus').innerHTML =
        '<span class="text-danger">‚ùå Erreur d\'upload. R√©essayez.</span>';
      audioPath = null;
    }
  }

  // Form submission
  document.getElementById('storyForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const btn = document.getElementById('submitBtn');
    const loading = document.getElementById('loading');
    const progress = document.getElementById('progress');

    // Validate input based on mode
    if (inputMode === 'text') {
      const topic = document.getElementById('topic').value.trim();
      if (!topic) {
        alert("Veuillez entrer un sujet pour l'histoire.");
        return;
      }
    } else {
      if (!audioPath) {
        alert('Veuillez enregistrer un message vocal.');
        return;
      }
    }

    btn.disabled = true;
    loading.classList.remove('d-none');

    const age = document.getElementById('age').value;
    const topic =
      inputMode === 'text' ? document.getElementById('topic').value : '';
    const moral = document.getElementById('moral').value;
    const duration = document.getElementById('duration').value;

    try {
      // Build URL with parameters
      let url = `/api/story/generate?age=${age}&moral=${encodeURIComponent(
        moral
      )}&duration=${duration}`;

      if (inputMode === 'text') {
        url += `&topic=${encodeURIComponent(topic)}`;
      } else {
        url += `&audio_path=${encodeURIComponent(audioPath)}`;
      }

      const response = await fetch(url, {
        method: 'POST',
        credentials: 'include',
      });

      if (response.status === 401) {
        alert('Session expir√©e. Veuillez vous reconnecter.');
        window.location.href = '/login';
        return;
      }

      const data = await response.json();
      const jobId = data.job_id;

      // Poll Status
      const interval = setInterval(async () => {
        const statusRes = await fetch(`/api/story/status/${jobId}`);
        const statusData = await statusRes.json();

        if (statusData.status === 'completed') {
          clearInterval(interval);
          window.location.href = `/story/${jobId}`;
        } else if (statusData.status === 'failed') {
          clearInterval(interval);
          const errorMsg =
            statusData.error_message || 'Erreur lors de la g√©n√©ration.';
          alert(errorMsg);
          btn.disabled = false;
          loading.classList.add('d-none');
        } else {
          progress.innerText = `(Chapitres pr√™ts: ${statusData.chapters_count})`;
        }
      }, 2000);
    } catch (error) {
      console.error(error);
      alert('Erreur de connexion');
      btn.disabled = false;
      loading.classList.add('d-none');
    }
  });
</script>
{% endblock %}
