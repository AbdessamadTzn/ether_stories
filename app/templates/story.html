{% extends "base.html" %} {% block content %}
<div class="container mt-5">
  <div class="text-center mb-5">
    <h1 class="display-4">{{ story.plan.plan.titre }}</h1>
    <p class="lead text-muted">
      {{ story.plan.plan.type_histoire }} â€¢ {{ story.plan.plan.duree_estimee }}
      min
    </p>

    <!-- Language Viewing Controls -->
    {% if available_translations %}
    <div class="mt-3">
      <span class="badge bg-info me-2">
        {% if current_lang %} {% if current_lang == 'en' %}ğŸ‡¬ğŸ‡§ English {% elif
        current_lang == 'ar' %}ğŸ‡¸ğŸ‡¦ Arabic {% elif current_lang == 'zh' %}ğŸ‡¨ğŸ‡³
        Chinese {% elif current_lang == 'es' %}ğŸ‡ªğŸ‡¸ Spanish {% elif current_lang
        == 'de' %}ğŸ‡©ğŸ‡ª German {% elif current_lang == 'pt' %}ğŸ‡§ğŸ‡· Portuguese {% elif
        current_lang == 'ru' %}ğŸ‡·ğŸ‡º Russian {% elif current_lang == 'ja' %}ğŸ‡¯ğŸ‡µ
        Japanese {% elif current_lang == 'ko' %}ğŸ‡°ğŸ‡· Korean {% elif current_lang
        == 'it' %}ğŸ‡®ğŸ‡¹ Italian {% endif %} {% else %} ğŸ‡«ğŸ‡· Original (French) {%
        endif %}
      </span>

      <div class="btn-group" role="group">
        <button
          type="button"
          class="btn btn-sm btn-primary dropdown-toggle"
          data-bs-toggle="dropdown"
        >
          ğŸ“– View Language
        </button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="?">ğŸ‡«ğŸ‡· Original (French)</a></li>
          <li><hr class="dropdown-divider" /></li>
          {% for lang in available_translations %}
          <li>
            <a class="dropdown-item" href="?lang={{ lang }}">
              {% if lang == 'en' %}ğŸ‡¬ğŸ‡§ English {% elif lang == 'ar' %}ğŸ‡¸ğŸ‡¦ Arabic
              {% elif lang == 'zh' %}ğŸ‡¨ğŸ‡³ Chinese {% elif lang == 'es' %}ğŸ‡ªğŸ‡¸
              Spanish {% elif lang == 'de' %}ğŸ‡©ğŸ‡ª German {% elif lang == 'pt' %}ğŸ‡§ğŸ‡·
              Portuguese {% elif lang == 'ru' %}ğŸ‡·ğŸ‡º Russian {% elif lang == 'ja'
              %}ğŸ‡¯ğŸ‡µ Japanese {% elif lang == 'ko' %}ğŸ‡°ğŸ‡· Korean {% elif lang ==
              'it' %}ğŸ‡®ğŸ‡¹ Italian {% endif %}
            </a>
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>
    {% endif %}

    <!-- Translation Controls -->
    <div class="mt-3">
      <div class="btn-group" role="group">
        <button
          type="button"
          class="btn btn-sm btn-outline-secondary dropdown-toggle"
          data-bs-toggle="dropdown"
        >
          ğŸŒ Translate Story
        </button>
        <ul class="dropdown-menu">
          <li>
            <a class="dropdown-item translate-btn" href="#" data-lang="en"
              >ğŸ‡¬ğŸ‡§ English</a
            >
          </li>
          <li>
            <a class="dropdown-item translate-btn" href="#" data-lang="zh"
              >ğŸ‡¨ğŸ‡³ Chinese</a
            >
          </li>
        </ul>
      </div>
    </div>

    <div id="translationStatus" class="mt-2"></div>
  </div>

  <div class="row justify-content-center">
    <div class="col-lg-8">
      {% for chapter in story.generated_chapters %}
      <div class="card mb-5 shadow-sm border-0">
        {% if chapter.image_path %}
        <img
          src="{{ chapter.image_path }}"
          class="card-img-top"
          alt="Illustration Chapitre {{ chapter.numero }}"
        />
        {% endif %}

        <div class="card-body p-4">
          <h3 class="card-title">
            Chapitre {{ chapter.numero }}: {{ chapter.titre }}
          </h3>
          <p class="card-text lead" style="line-height: 1.8">
            {{ chapter.contenu | replace('\n', '<br />') | safe }}
          </p>

          <!-- Audio Player Section -->
          <div class="mt-4">
            <div class="d-flex align-items-center gap-2 mb-2">
              <button
                type="button"
                class="btn btn-outline-primary listen-btn"
                data-chapter-id="{{ chapter.id }}"
                data-lang="{{ current_lang or 'fr' }}"
              >
                ğŸ”Š Ã‰couter
              </button>
              <span
                class="audio-status text-muted small"
                id="audio-status-{{ chapter.id }}"
              ></span>
            </div>
            <audio
              id="audio-player-{{ chapter.id }}"
              controls
              class="w-100 d-none"
            >
              Votre navigateur ne supporte pas l'audio.
            </audio>
          </div>
        </div>
      </div>
      {% endfor %}

      <div class="text-center mb-5">
        <a href="/my-stories" class="btn btn-outline-secondary btn-lg me-2"
          >ğŸ“š My Stories</a
        >
        <a href="/create" class="btn btn-outline-primary btn-lg"
          >âœ¨ Create Another</a
        >
      </div>
    </div>
  </div>
</div>

<script>
  // Get story ID from URL or template variable
  const storyId = '{{ story_id }}';
  const currentLang = '{{ current_lang or "fr" }}';

  // Listen button functionality
  document.querySelectorAll('.listen-btn').forEach((btn) => {
    btn.addEventListener('click', async (e) => {
      const chapterId = e.target.dataset.chapterId;
      const lang = e.target.dataset.lang || currentLang;
      const statusSpan = document.getElementById(`audio-status-${chapterId}`);
      const audioPlayer = document.getElementById(`audio-player-${chapterId}`);

      // Show loading state
      e.target.disabled = true;
      e.target.innerHTML = 'â³ Chargement...';
      statusSpan.textContent = '';

      try {
        const response = await fetch(
          `/api/chapter/${chapterId}/audio/${lang}`,
          {
            method: 'POST',
            credentials: 'include',
          }
        );

        const data = await response.json();

        if (response.ok) {
          // Show audio player
          audioPlayer.src = data.audio_url;
          audioPlayer.classList.remove('d-none');
          audioPlayer.play();

          // Update button
          e.target.innerHTML = 'ğŸ”Š Ã‰couter';
          e.target.disabled = false;

          // Show cached status
          if (data.cached) {
            statusSpan.textContent = '(from cache)';
          } else {
            statusSpan.textContent = 'âœ… Generated!';
          }
        } else {
          throw new Error(data.detail || 'Failed to generate audio');
        }
      } catch (error) {
        e.target.innerHTML = 'ğŸ”Š Ã‰couter';
        e.target.disabled = false;
        statusSpan.innerHTML = `<span class="text-danger">âŒ ${error.message}</span>`;
      }
    });
  });

  // Translation functionality
  document.querySelectorAll('.translate-btn').forEach((btn) => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      const lang = e.target.dataset.lang;
      const statusDiv = document.getElementById('translationStatus');

      statusDiv.innerHTML = `
        <div class="spinner-border spinner-border-sm" role="status"></div>
        <span class="ms-2">Translating to ${e.target.textContent}...</span>
      `;

      try {
        const response = await fetch(
          `/api/story/${storyId}/translate?lang=${lang}`,
          {
            method: 'POST',
            credentials: 'include',
          }
        );

        const data = await response.json();

        if (response.ok) {
          if (data.status === 'already_translated') {
            statusDiv.innerHTML = `
              <div class="alert alert-info">Already translated! Reload page to view.</div>
            `;
          } else {
            statusDiv.innerHTML = `
              <div class="alert alert-success">
                Translation started! This may take 1-2 minutes. Refresh the page after completion.
              </div>
            `;
          }
        } else {
          throw new Error(data.detail || 'Translation failed');
        }
      } catch (error) {
        statusDiv.innerHTML = `
          <div class="alert alert-danger">Error: ${error.message}</div>
        `;
      }
    });
  });
</script>

{% endblock %}
